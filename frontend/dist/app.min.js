!function(){"use strict";function e(e){return JSON.stringify(e,null,"  ")}var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function e(t,n,r){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(r)},i=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},a=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function e(){n(this,e),this.events={}}return r(e,[{key:"declareEvent",value:function(e){!1!==this.events.hasOwnProperty(e)&&!1!==Array.isArray(this.events[e])||(this.events[e]=[])}},{key:"on",value:function(e,t){if("function"!=typeof t)throw new Error('expected 2nd arg. to be of type "function"');if(!1===this.events.hasOwnProperty(e))throw new Error('"'+e+'" is not a recognized event');this.events[e].push(t)}},{key:"off",value:function(e,t){if("function"!=typeof t)throw new Error('expected 2nd arg. to be of type "function"');if(!1===this.events[e].hasOwnProperty(e))throw new Error('"'+e+'" is not a recognized event');if(!1===this.events[e].includes(t))throw new Error("event listener has not been attached yet");var n=this.events[e].indexOf(t);this.events[e].splice(n,1)}},{key:"trigger",value:function(e,t){if(!1===this.events.hasOwnProperty(e)&&!1===Array.isArray(this.events[e]))throw new Error('"'+e+'" is not a recognized event');this.events[e].forEach(function(e){e.apply({},t)})}}]),e}(),c=function(e){function t(e){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(e instanceof jQuery==!1||!1===jQuery(e).hasClass("control-surface"))throw new Error('expected arg. to be a jQuery object with class "control-surface"');var i=jQuery(e).find(".mp-control-button");return r.commands=jQuery(i).toArray().reduce(function(e,n){var i=jQuery(n).attr("data-command");return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"declareEvent",r).call(r,i),e[i]=n,jQuery(n).on("click",function(){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"trigger",r).call(r,i,[])}),e},{}),0!==jQuery(e).find(".spinner-wrapper").length?(r.spinner=jQuery(e).find(".spinner-wrapper"),r.spinnerOff()):r.spinner=null,0!==jQuery(e).find(".dropdown").length?r.dropdown=jQuery(e).find(".dropdown"):r.dropdown=null,r}return i(t,e),r(t,[{key:"on",value:function(e,n){"dropdown"===e&&null!==this.dropdown?jQuery(this.dropdown).on("change",function(e){n.apply({},[jQuery(e.currentTarget).val()])}):o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"on",this).call(this,e,n)}},{key:"get",value:function(e){if("dropdown"===e){if(null!==this.dropdown){return[null,jQuery(this.dropdown).val()]}return[new Error('control surface lacks <select> to support "'+e+'"'),""]}return[new Error('command "'+e+'" is not available from this control surface'),""]}},{key:"set",value:function(e,t){switch(e){case"dropdown":if(null===this.dropdown)throw new Error('control surface lacks <select> to support "'+e+'"');if(!(jQuery(this.dropdown).find('option[value="'+t+'"]').length>0))throw new Error("<select> has no option with the value "+t);jQuery(this.dropdown).val(t);break;default:throw new Error('command "'+e+'" is not available from this control surface')}}},{key:"startSpinning",value:function(e){if(!1===Object.keys(this.commands).includes(e))throw new Error('command "'+e+'" is not availalbe from this control surface');jQuery(this.commands[e]).addClass("icon-spinning")}},{key:"stopSpinning",value:function(e){if(!1===Object.keys(this.commands).includes(e))throw new Error('command "'+e+'" is not availalbe from this control surface');jQuery(this.commands[e]).removeClass("icon-spinning")}},{key:"disableCommands",value:function(e){var t=this;if(!1===Array.isArray(e))throw new Error("1st argument of ControlSurface.disableActions must be an array");e.forEach(function(e){if(!1===Object.keys(t.commands).includes(e))throw new Error('command "'+e+'" is not available from this control surface');jQuery(t.commands[e]).attr("disabled",!0)})}},{key:"enableCommands",value:function(e){var t=this;if(!1===Array.isArray(e))throw new Error("1st argument of ControlSurface.enableCommands must be an array");e.forEach(function(e){if(!1===Object.keys(t.commands).includes(e))throw new Error('command "'+e+'" is not available from this control surface');jQuery(t.commands[e]).attr("disabled",!1)})}},{key:"spinnerOn",value:function(){null!==this.spinner&&jQuery(this.spinner).addClass("show-spinner")}},{key:"spinnerOff",value:function(){null!==this.spinner&&jQuery(this.spinner).removeClass("show-spinner")}}]),t}(l),u={"&":"&amp;","<":"&lt;",">":"&gt"},d=function(e){return"string"!=typeof e&&(e=""+e),e.replace(/[&<>]/g,function(e){return u[e]||e})},f=function(e){return e.reduce(function(e,t){return e+t},"")},p=["children","classes","for","id","name","placeholder","title","type","value"];[["button",!1],["code",!1],["div",!1],["input",!0],["label",!1],["li",!1],["p",!1],["span",!1]].forEach(function(e){var n=e[0],r=e[1];f[n]=function(e,o){if("string"==typeof e){if("string"==typeof o){if(r)throw new Error("self closing tags like "+n+" can not have children");return"<"+n+' class="'+e+'">'+o+"</"+n+">"}if(void 0===o)return r?"<"+n+">":"<"+n+' class="'+e+'"></'+n+">";if(Array.isArray(o))return"<"+n+' class="'+e+'">'+o.join("")+"</"+n+">";throw console.log(o),new Error("un-recognized type of second argument")}if(Array.isArray(e)){if(r)throw new Error("self closing tags like "+n+" can not have children");return"<"+n+">"+e.join("")+"</"+n+">"}if("object"===(void 0===e?"undefined":t(e))){var i=Object.keys(e).reduce(function(t,n){if(!1===e.hasOwnProperty(n))return t;if("children"===n)return t;if(/^data-[a-zA-Z0-9\-_]*$/.test(n))return t+" "+n+'="'+e[n]+'"';if(p.includes(n))return"classes"===n?Array.isArray(e.classes)?t+' class="'+e.classes.join(" ")+'"':t+' class="'+e.classes+'"':t+" "+n+'="'+e[n]+'"';throw new Error('un-recognized attribute named: "'+n+'"')},"");if(r&&Array.isArray(e.children))throw new Error("self closing tags like "+n+" can not have children");var s="";if(void 0===e.children)s="";else if("string"==typeof e.children)s=e.children;else{if(!(e.children instanceof Array))throw console.error(e),new Error("un-recognized type of children field");s=e.children.map(function(e){return e.toString()}).join("")}return r?"<"+n+i+">":"<"+n+i+">"+s+"</"+n+">"}throw new Error("could not parse htmlBuilder inputs")}});var h=["fatal","alert","info","success"],g=function(e){function t(e,r,i,a){n(this,t);var l=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"declareEvent",l).call(l,"dismiss"),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"declareEvent",l).call(l,"close"),!1===h.includes(r))throw new Error('"'+r+'" is an invlaid notification type');return l.parent=e,l.type=r,l.title=d(i),l.large=!0===a.large,"string"==typeof a.code?(l.hasCode=!0,l.code=d(a.code).replace("\n","<br>")):(l.hasCode=!1,l.code=""),"string"==typeof a.details?(l.hasDetails=!0,l.details=d(a.details)):l.hasDetails=!1,l.actions=[],Array.isArray(a.actions)&&(l.actions=a.actions.reduce(function(e,n){return n.hasOwnProperty("name")&&n.hasOwnProperty("command")&&"string"==typeof n.name&&"string"==typeof n.command&&(e=e.concat({name:n.name,command:n.command}),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"declareEvent",l).call(l,n.command)),e},[])),l.expired=!1,l}return i(t,e),r(t,[{key:"on",value:function(e,n){if(!0===this.expired)throw new Error("notification has expired");o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"on",this).call(this,e,n)}},{key:"trigger",value:function(e,n){if(!0===this.expired)throw new Error("notification has expired");o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"trigger",this).call(this,e,n)}},{key:"open",value:function(){var e=this;if(!0===this.expired)throw new Error("notification has expired");if(this.parent instanceof jQuery==!1)throw new Error("notification has not parent element");var t="";t+=f.div({classes:["notif",this.type,this.large?"large":""],children:[f.div("tag"),this.large?f.button({classes:"dismiss",title:"Dismiss",children:"&times;"}):"",f.div({classes:"content",children:[f.p("title",this.title),this.hasCode?f.code({children:this.code}):"",this.hasDetails?f.p("details",this.details):"",this.actions.length>0?this.actions.reduce(function(e,t,n){return e+f.button({classes:"action","data-command":t.command,children:t.name})},""):""]})]});var n=jQuery(t);n.find("button.dismiss").on("click",function(){try{e.trigger("dismiss",[])}finally{e.close()}}),n.find("button[data-command]").on("click",function(t){var n=jQuery(t.currentTarget),r=n.attr("data-command");if("string"==typeof r)try{e.trigger(r,[])}finally{e.close()}}),this.elem=n,jQuery(this.parent).append(n),!1===this.large&&setTimeout(function(){e.close()},4e3)}},{key:"close",value:function(){var e=this;if(this.elem instanceof jQuery==!1)return!1;this.elem.addClass("close"),setTimeout(function(){null!==e.elem&&e.elem.remove(),e.elem=null,e.parent=null,e.expired=!0},300)}}]),t}(l),y=[],v=function(){function e(){n(this,e)}return r(e,null,[{key:"getElem",value:function(){return jQuery(".notif-bucket")}},{key:"send",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=e.getElem(),i=new g(o,t,n,r);return y.push(i),i.on("close",function(){var e=y.indexOf(i);y.splice(e,1)}),i}},{key:"flush",value:function(){y.forEach(function(e){e.close()})}}]),e}(),m=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";n(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"declareEvent",i).call(i,"apply-suggestion"),e instanceof jQuery==!1)throw new Error("expected argument to new EditorView() to be a jQuery object");return i.wrapperElem=e,i.editor=CodeMirror(i.wrapperElem[0],{mode:"text/x-java",theme:"neat",value:r,lineNumbers:!0,indentUnit:4,smartIndent:!1,tabSize:4,indentWithTabs:!0,electricChars:!1,gutters:["gutter-focus","CodeMirror-linenumbers"]}),i.focusedLines=[],i.highlightedLine=-1,i.frozen=!1,i.editor.on("gutterClick",function(e,t){!1===i.frozen&&i.toggleLineFocus(t)}),i}return i(t,e),r(t,[{key:"getProgram",value:function(){return this.editor.getValue()}},{key:"setProgram",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("string"!=typeof e)throw new Error("expected 1st arg. of EditorView.setProgram() to be a string");this.editor.setValue(e),!0===t&&this.editor.clearHistory()}},{key:"freeze",value:function(){this.frozen=!0,this.editor.setOption("readOnly","nocursor")}},{key:"unfreeze",value:function(){this.frozen=!1,this.editor.setOption("readOnly",!1),this.clearHighlightedLine(),this.editor.focus()}},{key:"highlightLine",value:function(e){if(!1===this.frozen)throw new Error("cannot highlight line until editor is frozen");e--,this.highlightedLine>=0&&this.clearHighlightedLine();this.editor.addLineClass(e,"gutter","active-line"),this.editor.addLineClass(e,"background","active-line"),this.editor.scrollIntoView({line:e,ch:0},20),this.highlightedLine=e}},{key:"clearHighlightedLine",value:function(){-1!==this.highlightedLine&&(this.editor.removeLineClass(this.highlightedLine,"gutter","active-line"),this.editor.removeLineClass(this.highlightedLine,"background","active-line"),this.highlightedLine=-1)}},{key:"toggleLineFocus",value:function(e){var t=(this.editor.lineInfo(e),this.focusedLines.indexOf(e));t>-1?(this.editor.removeLineClass(e,"gutter","focus-line"),this.editor.removeLineClass(e,"background","focus-line"),this.focusedLines.splice(t,1)):(this.editor.addLineClass(e,"gutter","focus-line"),this.editor.addLineClass(e,"background","focus-line"),this.focusedLines.push(e))}},{key:"clearFocusedLines",value:function(){var e=this;this.focusedLines.forEach(function(t){e.toggleLineFocus(t)})}},{key:"getFocusedLines",value:function(){return this.focusedLines.map(function(e){return e+1})}},{key:"makeSuggestion",value:function(e){var t=this,n=e.match(/\{([^\n]*)\}/);if(console.log("matches: ",n),null===n||n[1]&&0===n[1].length)throw console.error("RAW SUGGESTION: "+e),new Error("no suggestion");var r=n[1];r.split(",").filter(function(e,t){return 0===t}).forEach(function(e){var n=e.split("=");if(2!==n.length)throw new Error("no pairs: "+r);var o=parseInt(n[0],10),i=parseInt(n[1],10);if(isNaN(o))throw new Error("line is NaN: "+r);if(isNaN(i))throw new Error("value is NaN: "+r);var s=v.send("success","Possible change",{code:"add "+i+" on line #"+o+"?",large:!0,actions:[{name:"Change",command:"apply-suggestion"},{name:"Try again",command:"different-suggestion"}]});s.on("apply-suggestion",function(){var e=t.editor.getLine(o-1),n=e.replace(/\b\d+\b/,i.toString());t.editor.replaceRange(n,{line:o-1,ch:0},{line:o-1,ch:e.length}),t.trigger("apply-suggestion",[])}),s.on("different-suggestion",function(){v.send("info","Make different suggestion").open()}),s.on("dismiss",function(){v.send("info","Suggestion ignored").open()}),s.open()})}}]),t}(l),w=function(){function e(){n(this,e)}return r(e,null,[{key:"getTrace",value:function(t,n){console.log("payload:",t),console.log("cb:",n);var r=function(e){return void n(null,e)},o=function(r){var o=v.send("fatal","Network error getting trace2",{large:!0,details:"Trying again in a moment will likely fix this issue.",actions:[{name:"Try Again",command:"retry"}]});o.on("retry",function(){e.getTrace(t,n)}),o.on("dismiss",function(){n(r,[])}),o.open()};superagent.post("/trace").send(t.stringify()).end(function(e,t){if(e||!0!==t.ok)o(e);else{var n={};try{n=JSON.parse(t.text)}catch(e){o()}r(n)}})}},{key:"getSuggestion",value:function(t,n){var r=function(e){return console.log("Response: ",e),void n(null,e)};console.log("payload:",t),console.log("cb:",n);var o=function(r){var o=v.send("fatal","Network error getting trace1",{large:!0,details:"Trying again in a moment will likely fix this issue.",actions:[{name:"Try Again",command:"retry"}]});o.on("retry",function(){e.getSuggestion(t,n)}),o.on("dismiss",function(){n(r,[])}),o.open()};console.log("payload:",t.stringify()),superagent.post("/suggest").send(t.stringify()).end(function(e,t){e||!0!==t.ok?o(e):(console.log("response to post",t),r(t.text))})}}]),e}(),b=jQuery("#devtools-view"),k={fullTrace:b.find("#devtools-trace-json"),point:b.find("#devtools-mod-trace-json"),index:b.find("#devtools-mod-trace-index")};b.find(".close-devtools").on("click",function(){_.hidePanel()});var _=function(){function t(){n(this,t)}return r(t,null,[{key:"initializeClipboard",value:function(){new Clipboard("button[data-clipboard-target]")}},{key:"setWholeTrace",value:function(t){jQuery(k.fullTrace).val(e(t))}},{key:"setModifiedTracePoint",value:function(t,n){k.point.val(e(t)),k.index.val(n)}},{key:"clearTraceData",value:function(){k.fullTrace.val(""),k.point.val(""),k.index.val("")}},{key:"showPanel",value:function(){b.addClass("visible")}},{key:"hidePanel",value:function(){b.removeClass("visible")}}]),t}(),E=function(){function e(t,r,o,i){if(n(this,e),"string"!=typeof t)throw new Error("expected `trace` to have type String");if("string"!=typeof r)throw new Error("expected `point` to have type String");if("number"!=typeof o)throw new Error("expected `pointIndex` to have type Number");if(!1===Array.isArray(i))throw new Error("expected `focusedLines` to be an Array");i.forEach(function(e,t){if("number"!=typeof e)throw new Error("expected "+t+" element of `focusedLines` to have type Number")}),this.trace=t,this.point=r,this.pointIndex=o,this.focusedLines=i}return r(e,[{key:"stringify",value:function(){return JSON.stringify({full_trace:this.trace,modified_point:this.point,modified_point_index:this.pointIndex,focused_lines:this.focusedLines})}}]),e}(),j=function(e){function a(e){n(this,a);var t=s(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));if(t.cs=new c(e.find(".control-surface")),t.cs.disableCommands(["step-backward","step-forward","jump-start","jump-end"]),t.cs.on("step-backward",function(){!0===t.rendered&&t.index-1>=0&&t.setVisiblePoint(t.index-1)}),t.cs.on("step-forward",function(){!0===t.rendered&&t.index+1<t.trace.length&&t.setVisiblePoint(t.index+1)}),t.cs.on("jump-start",function(){!0===t.rendered&&t.trace.length>1&&t.setVisiblePoint(0)}),t.cs.on("jump-end",function(){!0===t.rendered&&t.trace.length>1&&t.setVisiblePoint(t.trace.length-1)}),t.wrapperElem=e,t.visualizationElem=e.find(".trace-visualization"),t.variablesElem=e.find(".variables-wrapper"),t.visualizationElem.length<1)throw new Error("missing .trace-visualization element");if(t.variablesElem.length<1)throw new Error("missing .variables-wrapper element");return o(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"declareEvent",t).call(t,"set-trace-point"),o(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"declareEvent",t).call(t,"get-suggestion"),t.rendered=!1,t.trace=[],t.scope={},t.index=0,t.showPendingMessage(),t}return i(a,e),r(a,[{key:"render",value:function(e){var n=this,r=e.trace;if(!1===Array.isArray(r))throw new Error("trace must be an array, received "+(void 0===r?"undefined":t(r)));var o=[],i="";i+=f(['<div class="scope top-level">','<ol class="execution">']),i+=r.reduceRight(function(e,t,n){var r=d(t.line);switch(t.event){case"instruction_limit_reached":return v.send("fatal","VM reached instruction limit",{large:!0,code:t.exception_msg}).open(),e;case"call":var i={};try{i=t.stack_to_render[0].encoded_locals}catch(e){throw new Error("cannot get local variables of point "+n)}var s=Object.keys(i).reduce(function(e,t){return!1===i.hasOwnProperty(t)?e:e.concat(f([f.span("sig-name",t),f.span("sig-syntax",":"),f.span("sig-value",""+i[t])]))},[]).join(f.span("sig-syntax",",")),a=d(t.func_name),l=o.pop();if(void 0===l.value)throw new Error("call with no return value");var c=d(l.value.toString());return f(['<li class="point call expanded">',f.input({type:"radio",id:"point-"+n,classes:["point-radio-button"],name:"point",value:n,"data-line":r}),f.label({classes:["func-sig"],for:"point-"+n,children:[f.span("sig-method",""+a),f.span("sig-syntax","("),s,f.span("sig-syntax",")"),"VOID"!==c?f.span("sig-syntax","&xrArr;"):"","VOID"!==c?f.span({classes:["sig-value","field","sig-return-value"],children:d(l.value.toString()),"data-point":d(l.index.toString())}):""]}),'<div class="scope">','<ol class="execution">'])+e;case"return":case"step_line":var u="return"===t.event;if(u){var p="VOID";try{p=t.stack_to_render[0].encoded_locals.__return__}catch(e){throw v.send("fatal","Malformed execution trace",{large:!0,code:"trace point "+n+' has type "return" but no `__return__` field',details:'Try running "Trace" again'}).open(),new Error('cannot get "__return__" field of point '+n)}o.push({value:p,line:t.line||-1,index:n})}return f([f.li("point",[f.input({type:"radio",id:"point-"+n,classes:["point-radio-button"],name:"point",value:n,"data-line":r}),f.label({for:"point-"+n})]),u?"</ol>":"",u?"</div>":"",u?"</li>":""])+e;default:throw console.error(t),new Error("cannot handle point at index "+n)}},""),i+=f(["</div>","</ol>"]),this.visualizationElem.html(i),this.visualizationElem.find('.scope input[type="radio"]').on("click",function(e){var t=jQuery(e.currentTarget).attr("id"),r=parseInt(t.replace("point-",""),10);isNaN(r)&&(r=0),n.setVisiblePoint(r)}),this.visualizationElem.find(".scope .sig-return-value").on("click",function(e){e.stopPropagation(),e.preventDefault();var t=parseInt(jQuery(e.currentTarget).attr("data-point"),10);if(isNaN(t))throw v.send("fatal","Unknown return point").open(),new Error("unknown return point");return n.setVisiblePoint(t,"__return__"),!1}),this.whole=e,this.trace=r,this.rendered=!0,this.initializeVariableView(),this.setVisiblePoint(0),this.cs.enableCommands(["step-backward","step-forward","jump-start","jump-end"])}},{key:"showPendingMessage",value:function(){var e='<p class="pending">waiting for execution trace&hellip;</p>';this.rendered=!1,this.visualizationElem.html(e),this.variablesElem.html(e)}},{key:"clear",value:function(){this.rendered=!1,this.trace=[],this.scope={},this.index=0,this.cs.disableCommands(["step-backward","step-forward","jump-start","jump-end"]),this.showPendingMessage()}},{key:"setVisiblePoint",value:function(e,t){if(!0===this.rendered){if(e>=this.trace.length||e<0)throw new Error("index "+e+" is out of range");var n=this.wrapperElem.find(".point-radio-button:eq("+e+")"),r=parseInt(n.attr("data-line"));if(isNaN(r))throw new Error("button at index "+e+' has corrupted "data-line" property');this.index=e,n.prop("checked",!0),this.setVisibleScope(e),o(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"trigger",this).call(this,"set-trace-point",[r]),"string"==typeof t&&this.variablesElem.find('ol li[data-variable="'+t+'"]').addClass("edit-alert").find(".edit").focus()}}},{key:"initializeVariableView",value:function(){var e=this;if(!0===this.rendered){this.variablesElem.html('<ol></ol><button class="action-button success">Get suggestions</button>'),this.variablesElem.find(".action-button.success").on("click",function(t){var n=e.variablesElem.find("ol li");if(n.length>0){var r=!1,o=n.toArray().filter(function(e){return""!==jQuery(e).find(".edit").val()}).map(function(e){var t=jQuery(e).find(".name").text(),n=jQuery(e).find(".value").text(),o=parseInt(n),i=jQuery(e).find(".edit").val(),s=parseInt(i);return isNaN(o)&&(r=!0,v.send("fatal","Could not request suggestions",{large:!0,code:'"'+t+'" is not type INTEGER'}).open()),isNaN(s)&&(r=!0,v.send("fatal","Could not request suggestions",{large:!0,code:'input "'+i+'" is not type INTEGER'}).open()),{varname:t,oldValue:o,newValue:s}});!1===r&&e.getSuggestions(o)}})}}},{key:"getSuggestions",value:function(e){if(!0===this.rendered){if(this.index>=this.trace.length||this.index<0)throw new Error("index "+this.index+" is out of range");var t=JSON.parse(JSON.stringify(this.trace[this.index]));t.stack_to_render[0].encoded_locals=e.reduce(function(e,t){return e[t.varname]=t.newValue,e},{}),t.stack_to_render[0].ordered_varnames=e.map(function(e){return e.varname});var n=JSON.stringify(this.whole),r=JSON.stringify(t),o=this.index,i=[];_.setModifiedTracePoint(t,o),this.trigger("get-suggestion",[new E(n,r,o,i)])}}},{key:"setVisibleScope",value:function(e){if(!0===this.rendered){if(e>=this.trace.length||e<0)throw new Error("index "+e+" is out of range");var t=this.trace[e],n=t.stack_to_render;if(!1===Array.isArray(n))throw new Error("malformed scope at index "+e);if(n.length>0){var r=n[0],o=r.encoded_locals||{},i=Object.keys(o).reduce(function(e,t){return!1===o.hasOwnProperty(t)?e:o[t]&&"VOID"===o[t][0]?e:e+f.li({"data-variable":d(t),children:[f.span("current",[f.span("name",d(t)),f.span("value field",d(o[t]))])," &xrarr; ",f.input({type:"textbox",classes:["edit"],placeholder:"?"})]})},"");this.variablesElem.find("ol").html(i)}}}}]),a}(l),x={tests:"public class Main {\n    static int SimpleJava() {\n        int a = 2;\n        int b = a + 1;\n        int c = a + b;\n        return c;\n    }\n\n    public static void main(String[] args) {\n        int x = SimpleJava();\n        System.out.println(x);\n    }\n}",hello:'public class HelloWorld {\n    public static void main(String[] args) {\n        System.out.println("Hello world");\n    }\n}',custom:""},O=function(){function e(){n(this,e)}return r(e,null,[{key:"workingCopyExists",value:function(e){if("function"!=typeof e)throw new Error("expected 1st arg. of Storage.workingCopyExists() to be a function");localforage.getItem("working_program_copy").then(function(t){var n="string"==typeof t;e.apply({},[null,n])}).catch(function(t){e.apply({},[t])})}},{key:"getWorkingCopy",value:function(e){if("function"!=typeof e)throw new Error("expected 1st arg. of Storage.getWorkingCopy() to be a function");localforage.getItem("working_program_copy").then(function(t){"string"!=typeof t&&(t=""),e.apply({},[null,t])}).catch(function(t){e.apply({},[t])})}},{key:"setWorkingCopy",value:function(e,t){if("string"!=typeof e)throw new Error("expected 1st arg. of Storage.setWorkingCopy() to be a string");if("function"!=typeof t)throw new Error("expected 2nd arg. of Storage.setWorkingCopy() to be a function");localforage.setItem("working_program_copy",e).then(function(e){t.apply({},[null,e])}).catch(function(e){t.apply({},[e])})}},{key:"setWorkingCopyFromBuiltin",value:function(t,n){if("string"!=typeof t){var r=new Error("expected 1st arg. of Storage.setWorkingCopyFromDefault() to be a string");return void n.apply({},[r])}if(!1===x.hasOwnProperty(t)){var o=new Error("1st arg. of Storage.setWorkingCopyFromDefault() not a valid ID");return void n.apply({},[o])}if("function"!=typeof n){var i=new Error("expected 3rd arg. of Storage.setWorkingCopy() to be a function");return void n.apply({},[i])}e.setWorkingCopy(x[t],n)}},{key:"clear",value:function(){(!0===(arguments.length>0&&void 0!==arguments[0]&&arguments[0])||window.confirm("Clear local storage?"))&&localforage.clear().then(function(){console.log("Local storage cleared")}).catch(function(e){console.error("Could not clear local storage. Error has been logged"),console.error(e)})}},{key:"workingCopyMatchesBuiltin",value:function(e){for(var t=Object.keys(x),n=0,r=t.length;n<r;n++){var o=t[n];if(x[o]===e)return o}return!1}}]),e}(),C=function(){function e(t,r){n(this,e),this.source=t,this.stdin=r}return r(e,[{key:"stringify",value:function(){return JSON.stringify({source:this.source,input:this.stdin})}}]),e}(),P=function(){function e(){n(this,e),this.edv=new m(jQuery(".mp-editor"),""),this.rtv=new j(jQuery(".mp-runtime")),this.mcs=new c(jQuery(".mp-controls")),this.requestPending=!0,this.requestCancelled=!1,this._init(),_.initializeClipboard()}return r(e,[{key:"_init",value:function(){var e=this,t=function(){e.mcs.disableCommands(["trace"]),e.mcs.startSpinning("trace"),e.mcs.enableCommands(["halt"]),e.rtv.showPendingMessage(),v.flush();var t=new C(e.edv.getProgram(),""),n=function n(r,o){if(e.requestPending=!1,!0===e.requestCancelled)return void(e.requestCancelled=!1);e.mcs.stopSpinning("trace");var i=o.trace;if(_.setWholeTrace(o),null!==r)throw v.send("fatal","Bad trace!").open(),r;if("instruction_limit_reached"===i[i.length-1].event){var s=v.send("fatal","Error generating trace",{large:!0,code:i[0].exception_msg,details:"Trying again in a moment will likely fix this issue.",actions:[{name:"Try Again",command:"retry"}]});s.on("retry",function(){e.mcs.startSpinning("trace"),w.getTrace(t,n)}),s.on("dismiss",function(){throw new Error(i[0].exception_msg)}),s.open()}else e.rtv.render(o)};e.requestCancelled=!1,e.requestPending=!0,w.getTrace(t,n)},n=function(t){e.mcs.disableCommands(["trace"]),e.mcs.startSpinning("trace"),e.mcs.enableCommands(["halt"]),t.focusedLines=e.edv.getFocusedLines(),v.flush();var n=function(t,n){if(console.log("Raw: ",n),e.requestPending=!1,!0===e.requestCancelled)return void(e.requestCancelled=!1);if(e.mcs.stopSpinning("trace"),null!==t)v.send("fatal","Error getting suggestion").open();else try{e.edv.makeSuggestion(n)}catch(t){"no suggestion"===t.message?v.send("alert","Could not make suggestion").open():v.send("fatal","Unknown error analyzing suggestion response",{code:t.message,large:!0}).open()}};e.requestCancelled=!1,e.requestPending=!0,w.getSuggestion(t,n)},r=function(){e.mcs.enableCommands(["trace"]),e.mcs.disableCommands(["halt"]),e.rtv.clear(),e.edv.unfreeze(),e.requestCancelled=!0,e.mcs.stopSpinning("trace"),_.clearTraceData()},o=function(){_.showPanel()},i=function(){var t=e.mcs.get("dropdown"),n=a(t,2),r=n[0],o=n[1];if(null!==r)return void console.error(r);O.setWorkingCopyFromBuiltin(o,function(t,n){null!==t?console.error(t):(console.log('loaded builtin program "'+o+'"'),e.edv.setProgram(n),e.mcs.trigger("halt",[]))})},s=function(t){O.setWorkingCopyFromBuiltin(t,function(n,r){null!==n?console.error(n):(console.log('loaded builtin program "'+t+'"'),e.edv.setProgram(r),e.mcs.trigger("halt",[]))})};this.mcs.on("trace",t),this.mcs.on("halt",r),this.mcs.on("debug",o),this.mcs.on("reset",i),this.mcs.on("dropdown",s),this.edv.on("apply-suggestion",t),this.rtv.on("set-trace-point",function(t){e.edv.freeze(),e.edv.highlightLine(t)}),this.rtv.on("get-suggestion",n),O.workingCopyExists(function(t,n){if(null!==t)return void console.error(t);n?O.getWorkingCopy(function(t,n){if(null!==t)console.error(t);else{console.log("loaded working copy from local storage");var r=O.workingCopyMatchesBuiltin(n);if("string"==typeof r)try{e.mcs.set("dropdown",r)}catch(t){console.error(t)}else try{e.mcs.set("dropdown","custom")}catch(t){console.error(t)}e.edv.setProgram(n,!0)}}):O.setWorkingCopyFromBuiltin("tests",function(t,n){if(null!==t)console.error(t);else{console.log("loaded default program as working copy");try{e.mcs.set("dropdown","tests")}catch(t){console.error(t)}e.edv.setProgram(n,!0)}})}),window.onbeforeunload=function(){O.setWorkingCopy(e.edv.getProgram(),function(e,t){null!==e?console.error(e):console.log("saved working copy to local storage")})}}}]),e}(),S=new P;window.app=S}();